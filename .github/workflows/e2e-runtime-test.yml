name: End-to-End Runtime Tests (Docker)

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft server version'
        required: false
        type: string
        default: '1.21.1'
      run_api_tests:
        description: 'Run HTTP API tests'
        required: false
        type: boolean
        default: true
      run_rcon_tests:
        description: 'Run RCON command tests'
        required: false
        type: boolean
        default: true
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.java'
      - 'pom.xml'
      - 'src/**'
      - 'plugin.yml'
      - '.github/workflows/e2e-runtime-test.yml'
      - '.github/test-fixtures/**'

# Allow parallel runs - each gets its own container with unique ports
concurrency:
  group: e2e-test-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read

env:
  JAVA_VERSION: '21'
  MC_VERSION: ${{ inputs.mc_version || '1.21.1' }}

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      skip-tests: true
      upload-coverage: false

  e2e-test:
    name: E2E Tests on Paper ${{ inputs.mc_version || '1.21.1' }}
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: dev-server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: target/

      - name: Prepare test info
        id: info
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          RUN_ID="e2e-${{ github.run_id }}-${SHORT_SHA}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT

      - name: Upload JAR to test server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          source: "target/SMPStats.jar"
          target: "/home/main/Minecraft-Servers/SMPStats-Dev/plugins-staging/${{ steps.info.outputs.run_id }}/"
          strip_components: 1

      - name: Start Docker container
        uses: appleboy/ssh-action@v1.0.3
        id: start
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
          MC_VERSION: ${{ env.MC_VERSION }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID,MC_VERSION
          script: |
            MANAGER="/home/main/Minecraft-Servers/SMPStats-Dev/manage-test-server.sh"
            PLUGIN_JAR="/home/main/Minecraft-Servers/SMPStats-Dev/plugins-staging/${RUN_ID}/SMPStats.jar"
            
            # Start container and capture connection info
            ${MANAGER} start "${RUN_ID}" "${PLUGIN_JAR}" "${MC_VERSION}" > /tmp/container-${RUN_ID}.json 2>&1
            
            # Extract last JSON block (the connection info)
            tail -10 /tmp/container-${RUN_ID}.json | grep -A 10 "^{" > /tmp/conn-${RUN_ID}.json || true
            cat /tmp/conn-${RUN_ID}.json

      - name: Get container connection info
        uses: appleboy/ssh-action@v1.0.3
        id: conn
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            cat /tmp/conn-${RUN_ID}.json

      - name: Wait for server startup
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            CONTAINER="smpstats-test-${RUN_ID}"
            
            echo "Waiting for SMPStats to fully initialize..."
            sleep 15
            
            echo "=== SMPStats Log Messages ==="
            docker logs "${CONTAINER}" 2>&1 | grep -i "SMPStats" || echo "No SMPStats messages yet"

      - name: Run RCON command tests
        if: ${{ inputs.run_rcon_tests != false }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            # Load connection info
            CONN_FILE="/tmp/conn-${RUN_ID}.json"
            RCON_PORT=$(cat "${CONN_FILE}" | grep rcon_port | grep -oP '\d+')
            RCON_PASS=$(cat "${CONN_FILE}" | grep rcon_password | grep -oP '": "\K[^"]+')
            
            echo "=== Running RCON Command Tests ==="
            echo "RCON Port: ${RCON_PORT}"
            
            FAILED=0
            
            # Test basic connectivity
            echo ""
            echo "Test 1: RCON Connectivity (/list)"
            RESULT=$(mcrcon -H localhost -P "${RCON_PORT}" -p "${RCON_PASS}" "list" 2>&1) || true
            echo "Result: $RESULT"
            if echo "$RESULT" | grep -qi "players"; then
              echo "âœ… PASS"
            else
              echo "âŒ FAIL"
              FAILED=$((FAILED + 1))
            fi
            
            # Test SMPStats info command
            echo ""
            echo "Test 2: /smpstats info"
            RESULT=$(mcrcon -H localhost -P "${RCON_PORT}" -p "${RCON_PASS}" "smpstats info" 2>&1) || true
            echo "Result: $RESULT"
            if echo "$RESULT" | grep -qi "smpstats\|version\|aktiv\|enabled"; then
              echo "âœ… PASS"
            else
              echo "âš ï¸ Unexpected response"
            fi
            
            # Test stats command
            echo ""
            echo "Test 3: /stats"
            RESULT=$(mcrcon -H localhost -P "${RCON_PORT}" -p "${RCON_PASS}" "stats" 2>&1) || true
            echo "Result: $RESULT"
            
            echo ""
            echo "=== RCON Tests Complete (${FAILED} failures) ==="
            
            if [ $FAILED -gt 0 ]; then
              exit 1
            fi

      - name: Run HTTP API tests
        if: ${{ inputs.run_api_tests != false }}
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            # Load connection info
            CONN_FILE="/tmp/conn-${RUN_ID}.json"
            API_PORT=$(cat "${CONN_FILE}" | grep api_port | grep -oP '\d+')
            API_KEY=$(cat "${CONN_FILE}" | grep api_key | grep -oP '": "\K[^"]+')
            
            echo "=== Running HTTP API Tests ==="
            echo "API Port: ${API_PORT}"
            
            API_URL="http://localhost:${API_PORT}"
            FAILED=0
            
            test_endpoint() {
              local name="$1"
              local endpoint="$2"
              local expected_status="$3"
              
              echo ""
              echo "Testing: $name"
              
              RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-API-Key: ${API_KEY}" "${API_URL}${endpoint}" 2>&1)
              STATUS=$(echo "$RESPONSE" | tail -1)
              BODY=$(echo "$RESPONSE" | sed '$d')
              
              if [ "$STATUS" = "$expected_status" ]; then
                echo "âœ… PASS - Status $STATUS"
                if [ "$STATUS" = "200" ]; then
                  if echo "$BODY" | jq empty 2>/dev/null; then
                    echo "   Valid JSON"
                  else
                    echo "   âš ï¸ Not valid JSON"
                  fi
                fi
              else
                echo "âŒ FAIL - Expected $expected_status, got $STATUS"
                FAILED=$((FAILED + 1))
              fi
            }
            
            # Test authentication (should fail without key)
            echo ""
            echo "Testing: Auth rejection (no key)"
            RESPONSE=$(curl -s -w "\n%{http_code}" "${API_URL}/stats/all" 2>&1)
            STATUS=$(echo "$RESPONSE" | tail -1)
            if [ "$STATUS" = "401" ]; then
              echo "âœ… PASS - Correctly rejected"
            else
              echo "âŒ FAIL - Expected 401, got $STATUS"
              FAILED=$((FAILED + 1))
            fi
            
            # Test valid endpoints
            test_endpoint "GET /stats/all" "/stats/all" "200"
            test_endpoint "GET /online" "/online" "200"
            test_endpoint "GET /moments/recent" "/moments/recent?limit=10" "200"
            test_endpoint "GET /health" "/health" "200"
            test_endpoint "GET /heatmap/MINING" "/heatmap/MINING" "200"
            
            # Test invalid UUID
            echo ""
            echo "Testing: Invalid UUID"
            RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-API-Key: ${API_KEY}" "${API_URL}/stats/invalid-uuid" 2>&1)
            STATUS=$(echo "$RESPONSE" | tail -1)
            if [ "$STATUS" = "400" ] || [ "$STATUS" = "404" ]; then
              echo "âœ… PASS - Status $STATUS"
            else
              echo "âŒ FAIL - Expected 400/404, got $STATUS"
              FAILED=$((FAILED + 1))
            fi
            
            echo ""
            echo "=== API Tests Complete (${FAILED} failures) ==="
            
            if [ $FAILED -gt 0 ]; then
              exit 1
            fi

      - name: Collect server logs
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            CONTAINER="smpstats-test-${RUN_ID}"
            LOG_DIR="/tmp/e2e-logs-${RUN_ID}"
            
            mkdir -p "${LOG_DIR}"
            
            echo "=== Full Server Log ==="
            docker logs "${CONTAINER}" > "${LOG_DIR}/server.log" 2>&1
            
            echo "=== SMPStats Messages ==="
            grep -i "SMPStats" "${LOG_DIR}/server.log" || echo "No SMPStats messages"
            
            echo ""
            echo "Logs saved to ${LOG_DIR}"

      - name: Stop and cleanup container
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            MANAGER="/home/main/Minecraft-Servers/SMPStats-Dev/manage-test-server.sh"
            
            echo "Stopping container..."
            ${MANAGER} stop "${RUN_ID}"
            
            # Cleanup staging files
            rm -rf "/home/main/Minecraft-Servers/SMPStats-Dev/plugins-staging/${RUN_ID}"
            rm -f "/tmp/container-${RUN_ID}.json" "/tmp/conn-${RUN_ID}.json"
            
            echo "Cleanup complete"

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Minecraft Version:** ${{ env.MC_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ steps.info.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **RCON Tests:** ${{ inputs.run_rcon_tests != false && 'âœ… Enabled' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Tests:** ${{ inputs.run_api_tests != false && 'âœ… Enabled' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Dynamic Docker container with unique ports" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel test runs supported" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-cleanup after test completion" >> $GITHUB_STEP_SUMMARY
