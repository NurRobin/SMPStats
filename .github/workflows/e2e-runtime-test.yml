name: End-to-End Runtime Tests

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft server version'
        required: false
        type: string
        default: '1.21.1'
      run_api_tests:
        description: 'Run HTTP API tests'
        required: false
        type: boolean
        default: true
      run_rcon_tests:
        description: 'Run RCON command tests'
        required: false
        type: boolean
        default: true
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.java'
      - 'pom.xml'
      - 'src/**'
      - 'plugin.yml'
      - '.github/workflows/e2e-runtime-test.yml'
      - '.github/test-fixtures/**'

concurrency:
  group: e2e-test-${{ github.ref }}
  cancel-in-progress: true

env:
  JAVA_VERSION: '21'
  MC_VERSION: ${{ inputs.mc_version || '1.21.1' }}
  API_PORT: 8765
  API_KEY: 'test-api-key-ci'
  RCON_PORT: 25575
  RCON_PASSWORD: 'test-rcon-password'
  SERVER_PORT: 25565

jobs:
  build:
    uses: ./.github/workflows/build.yml
    with:
      skip-tests: true
      upload-coverage: false

  e2e-test:
    name: E2E Tests on Paper ${{ inputs.mc_version || '1.21.1' }}
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: target/

      - name: Create test server directory
        run: |
          mkdir -p test-server/plugins
          cp target/SMPStats.jar test-server/plugins/

      - name: Create test configuration
        run: |
          mkdir -p test-server/plugins/SMPStats
          
          # Create test config with known API key and settings
          cat > test-server/plugins/SMPStats/config.yml << 'EOF'
          config_version: 5

          api:
            enabled: true
            bind_address: "0.0.0.0"
            port: ${{ env.API_PORT }}
            api_key: "${{ env.API_KEY }}"

          tracking:
            movement: true
            blocks: true
            kills: true
            biomes: true
            crafting: true
            damage: true
            consumption: true

          autosave_minutes: 1

          skills:
            mining:
              blocks_broken_weight: 0.05
            combat:
              player_kill_weight: 5.0
              mob_kill_weight: 2.0
              damage_dealt_weight: 0.02
            exploration:
              distance_weight: 0.01
              biomes_weight: 8.0
            builder:
              blocks_placed_weight: 0.05
            farmer:
              items_crafted_weight: 0.02
              items_consumed_weight: 0.01

          moments:
            enabled: true
            flush_seconds: 10
            definitions:
              diamond_run:
                type: block_break
                title: "Diamond Run"
                detail: "Diamonds found: {count}"
                merge_seconds: 30
                materials: [DIAMOND_ORE, DEEPSLATE_DIAMOND_ORE]

          heatmap:
            enabled: true
            flush_minutes: 5
            decay_half_life_hours: 0.0

          social:
            enabled: true
            sample_seconds: 5
            nearby_radius: 16

          timeline:
            enabled: true

          death_replay:
            enabled: true
            include_inventory_items: true
            nearby_radius: 16
            limit: 50

          health:
            enabled: true
            sample_minutes: 5
          EOF

      - name: Create server.properties
        run: |
          cat > test-server/server.properties << EOF
          server-port=${{ env.SERVER_PORT }}
          enable-rcon=true
          rcon.port=${{ env.RCON_PORT }}
          rcon.password=${{ env.RCON_PASSWORD }}
          online-mode=false
          spawn-protection=0
          max-players=5
          view-distance=4
          simulation-distance=4
          level-name=world
          motd=SMPStats E2E Test Server
          EOF

      - name: Accept EULA
        run: echo "eula=true" > test-server/eula.txt

      - name: Download Paper server
        run: |
          cd test-server
          
          # Get the latest build for the specified version
          BUILD_INFO=$(curl -s "https://api.papermc.io/v2/projects/paper/versions/${{ env.MC_VERSION }}/builds" | jq -r '.builds[-1]')
          BUILD_NUM=$(echo "$BUILD_INFO" | jq -r '.build')
          DOWNLOAD_NAME=$(echo "$BUILD_INFO" | jq -r '.downloads.application.name')
          
          echo "Downloading Paper ${{ env.MC_VERSION }} build ${BUILD_NUM}..."
          curl -L -o paper.jar \
            "https://api.papermc.io/v2/projects/paper/versions/${{ env.MC_VERSION }}/builds/${BUILD_NUM}/downloads/${DOWNLOAD_NAME}"
          
          echo "Paper server downloaded successfully"

      - name: Install mcrcon
        run: |
          git clone https://github.com/Tiiffi/mcrcon.git /tmp/mcrcon
          cd /tmp/mcrcon
          make
          sudo cp mcrcon /usr/local/bin/

      - name: Start Minecraft server
        id: start-server
        run: |
          cd test-server
          
          echo "Starting Paper server..."
          java -Xms512M -Xmx1G -jar paper.jar nogui &
          SERVER_PID=$!
          echo "server_pid=${SERVER_PID}" >> $GITHUB_OUTPUT
          
          # Wait for server to be ready (check for "Done" message)
          echo "Waiting for server to start..."
          TIMEOUT=180
          ELAPSED=0
          
          while [ $ELAPSED -lt $TIMEOUT ]; do
            if [ -f logs/latest.log ] && grep -q "Done" logs/latest.log; then
              echo "âœ… Server started successfully!"
              break
            fi
            sleep 5
            ELAPSED=$((ELAPSED + 5))
            echo "Waiting... (${ELAPSED}s / ${TIMEOUT}s)"
          done
          
          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "âŒ Server failed to start within timeout"
            if [ -f logs/latest.log ]; then
              echo "=== Server Log ==="
              cat logs/latest.log
            fi
            exit 1
          fi
          
          # Additional wait for plugins to fully initialize
          sleep 10
          
          # Verify SMPStats loaded
          if grep -q "\[SMPStats\] Enabling SMPStats" logs/latest.log; then
            echo "âœ… SMPStats plugin loaded successfully!"
          else
            echo "âŒ SMPStats plugin failed to load!"
            grep -i "smpstats\|error\|exception" logs/latest.log || true
            exit 1
          fi

      - name: Run RCON command tests
        if: ${{ inputs.run_rcon_tests != false }}
        run: |
          echo "=== Running RCON Command Tests ==="
          
          # Wait a moment for RCON to be ready
          sleep 5
          
          # Test basic connectivity
          echo "Testing RCON connectivity..."
          RESULT=$(mcrcon -H localhost -P ${{ env.RCON_PORT }} -p "${{ env.RCON_PASSWORD }}" "list" 2>&1) || true
          echo "List result: $RESULT"
          
          # Test SMPStats info command
          echo ""
          echo "Testing /smpstats info..."
          RESULT=$(mcrcon -H localhost -P ${{ env.RCON_PORT }} -p "${{ env.RCON_PASSWORD }}" "smpstats info" 2>&1) || true
          echo "Result: $RESULT"
          
          if echo "$RESULT" | grep -qi "smpstats\|version\|aktiv"; then
            echo "âœ… /smpstats info command works!"
          else
            echo "âš ï¸ Unexpected response from /smpstats info"
          fi
          
          # Test stats command (should work even without players)
          echo ""
          echo "Testing /stats..."
          RESULT=$(mcrcon -H localhost -P ${{ env.RCON_PORT }} -p "${{ env.RCON_PASSWORD }}" "stats" 2>&1) || true
          echo "Result: $RESULT"
          
          echo ""
          echo "=== RCON Command Tests Complete ==="

      - name: Run HTTP API tests
        if: ${{ inputs.run_api_tests != false }}
        run: |
          echo "=== Running HTTP API Tests ==="
          
          # Wait for API to be ready
          sleep 5
          
          API_URL="http://localhost:${{ env.API_PORT }}"
          API_KEY="${{ env.API_KEY }}"
          FAILED=0
          
          test_endpoint() {
            local name="$1"
            local endpoint="$2"
            local expected_status="$3"
            
            echo ""
            echo "Testing: $name ($endpoint)"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-API-Key: ${API_KEY}" "${API_URL}${endpoint}" 2>&1)
            STATUS=$(echo "$RESPONSE" | tail -1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "Status: $STATUS"
            
            if [ "$STATUS" = "$expected_status" ]; then
              echo "âœ… PASS - Expected status $expected_status"
              # Validate JSON if 200
              if [ "$STATUS" = "200" ]; then
                if echo "$BODY" | jq empty 2>/dev/null; then
                  echo "   Valid JSON response"
                else
                  echo "   âš ï¸ Response is not valid JSON: $BODY"
                fi
              fi
            else
              echo "âŒ FAIL - Expected $expected_status, got $STATUS"
              echo "   Response: $BODY"
              FAILED=$((FAILED + 1))
            fi
          }
          
          # Test authentication (should fail without key)
          echo ""
          echo "Testing: Authentication (no key)"
          RESPONSE=$(curl -s -w "\n%{http_code}" "${API_URL}/stats/all" 2>&1)
          STATUS=$(echo "$RESPONSE" | tail -1)
          if [ "$STATUS" = "401" ]; then
            echo "âœ… PASS - Correctly rejected unauthenticated request"
          else
            echo "âŒ FAIL - Expected 401, got $STATUS"
            FAILED=$((FAILED + 1))
          fi
          
          # Test valid endpoints
          test_endpoint "GET /stats/all" "/stats/all" "200"
          test_endpoint "GET /online" "/online" "200"
          test_endpoint "GET /moments/recent" "/moments/recent?limit=10" "200"
          test_endpoint "GET /health" "/health" "200"
          
          # Test invalid UUID (should be 400 or 404)
          echo ""
          echo "Testing: Invalid UUID"
          RESPONSE=$(curl -s -w "\n%{http_code}" -H "X-API-Key: ${API_KEY}" "${API_URL}/stats/invalid-uuid" 2>&1)
          STATUS=$(echo "$RESPONSE" | tail -1)
          if [ "$STATUS" = "400" ] || [ "$STATUS" = "404" ]; then
            echo "âœ… PASS - Correctly handled invalid UUID (status $STATUS)"
          else
            echo "âŒ FAIL - Expected 400 or 404, got $STATUS"
            FAILED=$((FAILED + 1))
          fi
          
          # Test heatmap endpoint
          test_endpoint "GET /heatmap/MINING" "/heatmap/MINING" "200"
          
          echo ""
          echo "=== HTTP API Tests Complete ==="
          
          if [ $FAILED -gt 0 ]; then
            echo "âŒ $FAILED test(s) failed!"
            exit 1
          else
            echo "âœ… All API tests passed!"
          fi

      - name: Capture server logs
        if: always()
        run: |
          echo "=== Server Logs (SMPStats messages) ==="
          if [ -f test-server/logs/latest.log ]; then
            grep -i "SMPStats" test-server/logs/latest.log || echo "No SMPStats messages found"
          else
            echo "Log file not found"
          fi

      - name: Stop Minecraft server
        if: always()
        run: |
          echo "Stopping server..."
          
          # Try graceful shutdown via RCON
          mcrcon -H localhost -P ${{ env.RCON_PORT }} -p "${{ env.RCON_PASSWORD }}" "stop" 2>/dev/null || true
          
          sleep 10
          
          # Force kill if still running
          pkill -f "paper.jar" || true
          
          echo "Server stopped"

      - name: Upload server logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-server-logs-${{ github.run_id }}
          path: |
            test-server/logs/
            test-server/plugins/SMPStats/
          retention-days: 3
          if-no-files-found: warn

      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ§ª E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Minecraft Version:** ${{ env.MC_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **RCON Tests:** ${{ inputs.run_rcon_tests != false && 'âœ… Enabled' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **API Tests:** ${{ inputs.run_api_tests != false && 'âœ… Enabled' || 'â­ï¸ Skipped' }}" >> $GITHUB_STEP_SUMMARY
