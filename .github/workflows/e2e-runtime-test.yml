name: End-to-End Runtime Tests (Docker)

on:
  workflow_dispatch:
    inputs:
      mc_version:
        description: 'Minecraft server version'
        required: false
        type: string
        default: '1.21.1'
      run_api_tests:
        description: 'Run HTTP API tests'
        required: false
        type: boolean
        default: true
      run_rcon_tests:
        description: 'Run RCON command tests'
        required: false
        type: boolean
        default: true
  pull_request:
    branches:
      - main
      - dev
    paths:
      - '**.java'
      - 'pom.xml'
      - 'src/**'
      - 'plugin.yml'
      - '.github/workflows/e2e-runtime-test.yml'
      - '.github/test-fixtures/**'

# Allow parallel runs - each gets its own container with unique ports
concurrency:
  group: e2e-test-${{ github.ref }}-${{ github.run_id }}
  cancel-in-progress: false

permissions:
  contents: read
  pull-requests: write

env:
  JAVA_VERSION: '21'
  MC_VERSION: ${{ inputs.mc_version || '1.21.1' }}

jobs:
  # Early skip detection - runs in <10s and saves expensive Docker/SSH operations
  changes:
    name: Check for relevant changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    outputs:
      should_run: ${{ steps.filter.outputs.relevant }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check for code changes
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            relevant:
              - '**.java'
              - 'pom.xml'
              - 'src/**'
              - 'plugin.yml'
              - '.github/workflows/e2e-runtime-test.yml'
              - '.github/test-fixtures/**'

      - name: Skip notification
        if: steps.filter.outputs.relevant == 'false'
        run: |
          echo "## ‚è≠Ô∏è E2E Tests Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No changes to code, build files, or test fixtures detected." >> $GITHUB_STEP_SUMMARY
          echo "Skipping expensive Docker-based E2E tests." >> $GITHUB_STEP_SUMMARY

  build:
    needs: [changes]
    if: always() && (github.event_name == 'workflow_dispatch' || needs.changes.outputs.should_run == 'true' || needs.changes.result == 'skipped')
    uses: ./.github/workflows/build.yml
    with:
      skip-tests: true
      upload-coverage: false

  e2e-test:
    name: E2E Tests on Paper ${{ inputs.mc_version || '1.21.1' }}
    needs: [changes, build]
    if: always() && needs.build.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    environment: dev-server

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download built artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact-name }}
          path: target/

      - name: Prepare test info
        id: info
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          RUN_ID="e2e-${{ github.run_id }}-${SHORT_SHA}"
          
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "run_id=${RUN_ID}" >> $GITHUB_OUTPUT

      - name: Upload JAR to test server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          source: "target/SMPStats.jar"
          target: "/opt/smpstats-ci/plugins-staging/${{ steps.info.outputs.run_id }}/"
          strip_components: 1

      - name: Start Docker container
        uses: appleboy/ssh-action@v1.0.3
        id: start
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
          MC_VERSION: ${{ env.MC_VERSION }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID,MC_VERSION
          script: |
            MANAGER="/opt/smpstats-ci/manage-test-server.sh"
            PLUGIN_JAR="/opt/smpstats-ci/plugins-staging/${RUN_ID}/SMPStats.jar"
            
            # Start container - logs go to stderr, JSON to stdout
            ${MANAGER} start "${RUN_ID}" "${PLUGIN_JAR}" "${MC_VERSION}" 2>/tmp/container-${RUN_ID}.log | tee /tmp/conn-${RUN_ID}.json
            
            # Verify JSON was captured
            echo "=== Connection Info ==="
            cat /tmp/conn-${RUN_ID}.json
            
            # Validate JSON
            if jq -e . /tmp/conn-${RUN_ID}.json >/dev/null 2>&1; then
              echo "‚úÖ Valid JSON captured"
            else
              echo "‚ö†Ô∏è JSON extraction failed, attempting recovery..."
              # Try to extract JSON from the output
              grep -A 20 '^{' /tmp/conn-${RUN_ID}.json | head -15 > /tmp/conn-${RUN_ID}.json.tmp
              mv /tmp/conn-${RUN_ID}.json.tmp /tmp/conn-${RUN_ID}.json
              cat /tmp/conn-${RUN_ID}.json
            fi

      - name: Get container connection info
        uses: appleboy/ssh-action@v1.0.3
        id: conn
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            cat /tmp/conn-${RUN_ID}.json

      - name: Wait for server startup
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            CONTAINER="smpstats-test-${RUN_ID}"
            
            echo "Waiting for SMPStats to fully initialize..."
            sleep 15
            
            echo "=== SMPStats Log Messages ==="
            docker logs "${CONTAINER}" 2>&1 | grep -i "SMPStats" || echo "No SMPStats messages yet"

      - name: Upload E2E test script
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          source: ".github/test-fixtures/run-e2e-tests.sh"
          target: "/opt/smpstats-ci/plugins-staging/${{ steps.info.outputs.run_id }}/"
          strip_components: 2

      - name: Run comprehensive E2E tests
        id: e2e_tests
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
          RUN_RCON: ${{ inputs.run_rcon_tests != false }}
          RUN_API: ${{ inputs.run_api_tests != false }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID,RUN_RCON,RUN_API
          command_timeout: 5m
          script: |
            # Load connection info with debug output
            CONN_FILE="/tmp/conn-${RUN_ID}.json"
            RESULTS_FILE="/tmp/e2e-results-${RUN_ID}.json"
            
            echo "=== Debug: Connection file contents ==="
            cat "${CONN_FILE}" || echo "File not found!"
            echo "=== End of connection file ==="
            
            # Parse JSON - handle both clean JSON and mixed output
            if jq -e . "${CONN_FILE}" >/dev/null 2>&1; then
              RCON_PORT=$(jq -r '.rcon_port' "${CONN_FILE}")
              RCON_PASS=$(jq -r '.rcon_password' "${CONN_FILE}")
              API_PORT=$(jq -r '.api_port' "${CONN_FILE}")
              API_KEY=$(jq -r '.api_key' "${CONN_FILE}")
              DASHBOARD_PORT=$(jq -r '.dashboard_port' "${CONN_FILE}")
              ADMIN_PASS=$(jq -r '.admin_password' "${CONN_FILE}")
            else
              echo "WARNING: JSON parsing failed, trying to extract from mixed output..."
              # Extract JSON block from potentially mixed output
              CONN_JSON=$(grep -A 20 '^{' "${CONN_FILE}" | head -15)
              RCON_PORT=$(echo "$CONN_JSON" | jq -r '.rcon_port')
              RCON_PASS=$(echo "$CONN_JSON" | jq -r '.rcon_password')
              API_PORT=$(echo "$CONN_JSON" | jq -r '.api_port')
              API_KEY=$(echo "$CONN_JSON" | jq -r '.api_key')
              DASHBOARD_PORT=$(echo "$CONN_JSON" | jq -r '.dashboard_port')
              ADMIN_PASS=$(echo "$CONN_JSON" | jq -r '.admin_password')
            fi
            
            # Validate we got real values
            if [ -z "$RCON_PORT" ] || [ "$RCON_PORT" = "null" ]; then
              echo "ERROR: Failed to extract RCON_PORT from connection info"
              # Save error to results file
              echo '{"status":"error","message":"Failed to extract RCON_PORT from connection info","tests":[]}' > "${RESULTS_FILE}"
              exit 1
            fi
            
            # Setup test script
            TEST_SCRIPT="/opt/smpstats-ci/plugins-staging/${RUN_ID}/run-e2e-tests.sh"
            chmod +x "${TEST_SCRIPT}"
            
            echo "=== Running Comprehensive E2E Tests ==="
            echo "RCON Port: ${RCON_PORT}"
            echo "API Port: ${API_PORT}"
            echo "Dashboard Port: ${DASHBOARD_PORT}"
            echo ""
            
            # Run the comprehensive test suite and capture output
            TEST_OUTPUT=$("${TEST_SCRIPT}" \
              "${RCON_PORT}" \
              "${RCON_PASS}" \
              "${API_PORT}" \
              "${API_KEY}" \
              "${DASHBOARD_PORT}" \
              "${ADMIN_PASS}" \
              "localhost" 2>&1) || TEST_EXIT_CODE=$?
            
            # Echo output for logs
            echo "$TEST_OUTPUT"
            
            # Parse results from output and save to JSON
            PASSED=$(echo "$TEST_OUTPUT" | grep -oP '(?<=Passed: )\d+' | tail -1 || echo "0")
            FAILED=$(echo "$TEST_OUTPUT" | grep -oP '(?<=Failed: )\d+' | tail -1 || echo "0")
            SKIPPED=$(echo "$TEST_OUTPUT" | grep -oP '(?<=Skipped: )\d+' | tail -1 || echo "0")
            
            # Extract failed test names (lines containing ‚úó)
            FAILED_TESTS=$(echo "$TEST_OUTPUT" | grep '‚úó' | sed 's/\x1b\[[0-9;]*m//g' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            
            # Extract passed test names (lines containing ‚úì)
            PASSED_TESTS=$(echo "$TEST_OUTPUT" | grep '‚úì' | sed 's/\x1b\[[0-9;]*m//g' | jq -R -s -c 'split("\n") | map(select(length > 0))')
            
            # Create results JSON
            cat > "${RESULTS_FILE}" << EOF
            {
              "status": "$([ "${TEST_EXIT_CODE:-0}" = "0" ] && echo "success" || echo "failure")",
              "passed": ${PASSED:-0},
              "failed": ${FAILED:-0},
              "skipped": ${SKIPPED:-0},
              "failed_tests": ${FAILED_TESTS:-[]},
              "passed_tests": ${PASSED_TESTS:-[]},
              "rcon_port": "${RCON_PORT}",
              "api_port": "${API_PORT}",
              "dashboard_port": "${DASHBOARD_PORT}"
            }
            EOF
            
            echo ""
            echo "=== Results saved to ${RESULTS_FILE} ==="
            cat "${RESULTS_FILE}"
            
            # Exit with original test exit code
            exit ${TEST_EXIT_CODE:-0}

      - name: Fetch test results
        id: fetch_results
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            RESULTS_FILE="/tmp/e2e-results-${RUN_ID}.json"
            if [ -f "${RESULTS_FILE}" ]; then
              cat "${RESULTS_FILE}"
            else
              echo '{"status":"unknown","message":"Results file not found","passed":0,"failed":0,"skipped":0,"failed_tests":[]}'
            fi

      - name: Comment on PR with test results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `${{ steps.fetch_results.outputs.stdout }}` || '{}';
            let results;
            try {
              results = JSON.parse(output.trim());
            } catch (e) {
              results = { status: 'error', message: 'Failed to parse test results', passed: 0, failed: 0, skipped: 0, failed_tests: [] };
            }
            
            const status = results.status || 'unknown';
            const passed = results.passed || 0;
            const failed = results.failed || 0;
            const skipped = results.skipped || 0;
            const failedTests = results.failed_tests || [];
            const rconPort = results.rcon_port || 'N/A';
            const apiPort = results.api_port || 'N/A';
            const dashboardPort = results.dashboard_port || 'N/A';
            
            let statusEmoji = status === 'success' ? '‚úÖ' : status === 'failure' ? '‚ùå' : '‚ö†Ô∏è';
            let statusText = status === 'success' ? 'All tests passed!' : status === 'failure' ? 'Some tests failed' : 'Test status unknown';
            
            let body = `## ${statusEmoji} E2E Test Results\n\n`;
            body += `**Status:** ${statusText}\n\n`;
            body += `### üìä Summary\n`;
            body += `| Metric | Count |\n`;
            body += `|--------|-------|\n`;
            body += `| ‚úÖ Passed | ${passed} |\n`;
            body += `| ‚ùå Failed | ${failed} |\n`;
            body += `| ‚è≠Ô∏è Skipped | ${skipped} |\n\n`;
            
            body += `### üîß Test Environment\n`;
            body += `- **Minecraft Version:** ${{ env.MC_VERSION }}\n`;
            body += `- **Plugin Version:** ${{ needs.build.outputs.version }}\n`;
            body += `- **RCON Port:** ${rconPort}\n`;
            body += `- **API Port:** ${apiPort}\n`;
            body += `- **Dashboard Port:** ${dashboardPort}\n\n`;
            
            if (failed > 0 && failedTests.length > 0) {
              body += `### ‚ùå Failed Tests\n\n`;
              body += `<details>\n<summary>Click to expand failed test details</summary>\n\n`;
              body += `\`\`\`\n`;
              failedTests.forEach(test => {
                body += `${test}\n`;
              });
              body += `\`\`\`\n</details>\n\n`;
              
              // Categorize failures for quick reference
              const rconFails = failedTests.filter(t => t.includes('RCON') || t.includes('command'));
              const apiFails = failedTests.filter(t => t.includes('API') || t.includes('/stats') || t.includes('/health') || t.includes('/heatmap'));
              const dashFails = failedTests.filter(t => t.includes('Dashboard') || t.includes('dashboard') || t.includes('admin'));
              const dbFails = failedTests.filter(t => t.includes('Database') || t.includes('database') || t.includes('sqlite'));
              const intFails = failedTests.filter(t => t.includes('Integration') || t.includes('consistency'));
              
              if (rconFails.length > 0) body += `- üéÆ **RCON/Commands:** ${rconFails.length} failure(s)\n`;
              if (apiFails.length > 0) body += `- üåê **HTTP API:** ${apiFails.length} failure(s)\n`;
              if (dashFails.length > 0) body += `- üìä **Dashboard:** ${dashFails.length} failure(s)\n`;
              if (dbFails.length > 0) body += `- üíæ **Database:** ${dbFails.length} failure(s)\n`;
              if (intFails.length > 0) body += `- üîó **Integration:** ${intFails.length} failure(s)\n`;
            }
            
            body += `\n---\n`;
            body += `*Run ID: ${{ steps.info.outputs.run_id }} | [View full logs](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;
            
            // Find existing comment to update or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('E2E Test Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Collect server logs
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            CONTAINER="smpstats-test-${RUN_ID}"
            LOG_DIR="/tmp/e2e-logs-${RUN_ID}"
            
            mkdir -p "${LOG_DIR}"
            
            echo "=== Full Server Log ==="
            docker logs "${CONTAINER}" > "${LOG_DIR}/server.log" 2>&1
            
            echo "=== SMPStats Messages ==="
            grep -i "SMPStats" "${LOG_DIR}/server.log" || echo "No SMPStats messages"
            
            echo ""
            echo "Logs saved to ${LOG_DIR}"

      - name: Stop and cleanup container
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        env:
          RUN_ID: ${{ steps.info.outputs.run_id }}
        with:
          host: ${{ secrets.DEV_SERVER_HOST }}
          username: ${{ secrets.DEV_SERVER_USER }}
          key: ${{ secrets.DEV_SERVER_SSH_KEY }}
          port: ${{ secrets.DEV_SERVER_SSH_PORT }}
          envs: RUN_ID
          script: |
            MANAGER="/opt/smpstats-ci/manage-test-server.sh"
            CONTAINER="smpstats-test-${RUN_ID}"
            
            echo "=== Stopping and removing container ==="
            ${MANAGER} stop "${RUN_ID}"
            
            # Double-check container is removed (--rm flag should handle this)
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
              echo "Container still exists, force removing..."
              docker rm -f "${CONTAINER}" 2>/dev/null || true
            fi
            
            # Verify container is gone
            if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER}$"; then
              echo "‚ö†Ô∏è WARNING: Container may not be fully removed"
            else
              echo "‚úÖ Container successfully removed"
            fi
            
            # Cleanup all staging and temp files
            rm -rf "/opt/smpstats-ci/plugins-staging/${RUN_ID}"
            rm -f "/tmp/container-${RUN_ID}.json" "/tmp/conn-${RUN_ID}.json" "/tmp/e2e-results-${RUN_ID}.json"
            rm -rf "/tmp/e2e-logs-${RUN_ID}"
            
            echo "‚úÖ Cleanup complete"

      - name: Test summary
        if: always()
        run: |
          echo "## üß™ E2E Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Minecraft Version:** ${{ env.MC_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Plugin Version:** ${{ needs.build.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** ${{ steps.info.outputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Categories" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
          echo "| üéÆ RCON Commands | Plugin commands via server console |" >> $GITHUB_STEP_SUMMARY
          echo "| üåê HTTP API | RESTful API endpoint validation |" >> $GITHUB_STEP_SUMMARY
          echo "| üìä Dashboard | Web dashboard and admin panel |" >> $GITHUB_STEP_SUMMARY
          echo "| üíæ Database | Data structure and consistency |" >> $GITHUB_STEP_SUMMARY
          echo "| üîó Integration | Cross-component consistency |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Infrastructure" >> $GITHUB_STEP_SUMMARY
          echo "- Dynamic Docker container with unique ports" >> $GITHUB_STEP_SUMMARY
          echo "- Parallel test runs supported" >> $GITHUB_STEP_SUMMARY
          echo "- Auto-cleanup after test completion" >> $GITHUB_STEP_SUMMARY
