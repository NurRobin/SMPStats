name: Policy Guard

on:
  pull_request:
    branches: [main, dev]

permissions:
  contents: read
  pull-requests: read

jobs:
  guard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enforce branch policy
        run: |
          BASE="${{ github.event.pull_request.base.ref }}"
          HEAD="${{ github.event.pull_request.head.ref }}"
          if [[ "$HEAD" =~ ^(feat|fix|refactor|chore|docs|test)/ ]] && [[ "$BASE" == "main" ]]; then
            echo "Feature/refactor/fix branches should target dev instead of main."
            exit 1
          fi

      - name: Require changelog entry
        run: |
          set -e
          BASE="${{ github.event.pull_request.base.ref }}"
          git fetch origin "$BASE" --depth=1

          SKIP=$(python - <<'PY'
import json, os
labels=[l["name"] for l in json.load(open(os.environ["GITHUB_EVENT_PATH"]))["pull_request"].get("labels", [])]
print("yes" if "skip-changelog" in labels else "")
PY
)
          if [[ "$SKIP" == "yes" ]]; then
            echo "skip-changelog label present; skipping changelog check."
            exit 0
          fi

          if ! git diff --name-only origin/"$BASE"...HEAD | grep -E '^docs/changelog/'; then
            echo "Add a changelog entry under docs/changelog/ (or add the skip-changelog label)."
            exit 1
          fi
